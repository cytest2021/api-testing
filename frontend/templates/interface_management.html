{% extends "index.html" %}
{% block head %}
<!-- 引入 Bootstrap 图标 CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
{% endblock %}
{% block content %}
<div class="container-fluid p-0" style="height: 100vh;">
  <div class="row g-0 h-100">
    <!-- 左侧项目&接口树 -->
    <div class="col-lg-3 bg-light border-end h-100 overflow-auto">
      <div class="p-3">
        <h5 class="fw-bold mb-3">项目列表</h5>
        <ul class="list-unstyled" id="projectTree">
          <li class="text-muted">加载项目中...</li>
        </ul>
      </div>
    </div>
    <!-- 右侧接口详情 -->
    <div class="col-lg-9 h-100 overflow-auto">
      <div class="p-4" id="interfaceDetail">
<!--        <h5 class="fw-bold mb-4">请选择左侧接口查看详情</h5>-->
        <div class="alert alert-info" role="alert">
          从左侧项目列表中展开项目，点击接口名称以查看详情
        </div>
      </div>
    </div>
  </div>
</div>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
$(document).ready(function () {
  loadProjectTree();
  $(document).on("click", ".interface-item", function () {
    const interfaceId = $(this).data("interface-id");
    loadInterfaceDetail(interfaceId);
  });
});
function loadProjectTree() {
  $.ajax({
    url: '/api/all-projects',
    type: 'GET',
    beforeSend: function () {
      $('#projectTree').html('<li class="text-muted">加载项目中...</li>');
    },
    success: function (res) {
      const projectTree = $("#projectTree");
      projectTree.empty();
      if (res.code === 200 && res.data && res.data.length > 0) {
        res.data.forEach((project) => {
          const projectNode = `
            <li class="mb-3">
              <div class="d-flex justify-content-between align-items-center bg-white p-2 rounded border shadow-sm">
                <span class="fw-medium">
                  ${project.name}
                  <span class="bi bi-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="${project.description || '暂无项目描述'}"></span>
                </span>
                <button class="btn btn-sm btn-outline-primary project-toggle" data-project-id="${project.id}">
                  <i class="fas fa-chevron-down"></i>
                </button>
              </div>
              <ul class="list-unstyled pl-3 mt-1 d-none" id="interfaces-project-${project.id}">
                <!-- 接口列表将在这里动态加载 -->
              </ul>
            </li>
          `;
          projectTree.append(projectNode);
        });
        // 项目列表加载完成后，初始化工具提示
        $('[data-bs-toggle="tooltip"]').tooltip();
        $(".project-toggle").click(function () {
          const projectId = $(this).data("project-id");
          const interfaceList = $(`#interfaces-project-${projectId}`);
          if (interfaceList.hasClass('d-none')) {
            // 加载接口前先清空并显示加载提示
            interfaceList.empty().append('<li class="text-muted">加载接口中...</li>').toggleClass("d-none");
            loadProjectInterfaces(projectId);
          } else {
            interfaceList.toggleClass("d-none");
          }
          $(this).find("i").toggleClass("fa-chevron-down fa-chevron-up");
        });
      } else {
        projectTree.html('<li class="text-danger">暂无项目数据</li>');
      }
    },
    error: function (err) {
      $('#projectTree').html('<li class="text-danger">加载项目失败，请重试</li>');
      console.error('加载项目出错：', err);
    }
  });
}
function loadProjectInterfaces(projectId) {
  $.ajax({
    url: `/api/project/${projectId}/interfaces`,
    type: 'GET',
    success: function (res) {
      const interfaceList = $(`#interfaces-project-${projectId}`);
      interfaceList.empty();
      // 先添加更新和删除项目按钮
      const projectButtons = `
        <li class="mb-2">
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-warning update-project" data-project-id="${projectId}">更新项目</button>
            <button class="btn btn-sm btn-danger delete-project" data-project-id="${projectId}">删除项目</button>
          </div>
        </li>
      `;
      interfaceList.append(projectButtons);
      if (res.code === 200 && res.data && res.data.length > 0) {
        res.data.sort((a, b) => a.interface.id - b.interface.id);
        res.data.forEach(iface => {
          const interfaceItem = `
            <li class="mb-1">
              <button class="btn btn-link w-100 text-start interface-item" data-interface-id="${iface.interface.id}">
                <span class="badge bg-${
                  iface.interface.method === "GET"
                    ? "info"
                    : iface.interface.method === "POST"
                    ? "success"
                    : iface.interface.method === "PUT"
                    ? "warning"
                    : "danger"
                } me-2">${iface.interface.method}</span>
                ${iface.interface.name}
              </button>
            </li>
          `;
          interfaceList.append(interfaceItem);
        });
      } else {
        interfaceList.append('<li class="text-muted">该项目下无接口</li>');
      }
    },
    error: function (err) {
      $(`#interfaces-project-${projectId}`).html('<li class="text-danger">加载接口失败</li>');
      console.error('加载接口出错：', err);
    }
  });
}
function loadInterfaceDetail(interfaceId) {
  $.ajax({
    url: `/api/interface/${interfaceId}/detail`,
    type: 'GET',
    beforeSend: function () {
      $('#interfaceDetail').html('<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>');
    },
    success: function (res) {
      if (res.code === 200 && res.data) {
        renderInterfaceDetail(res.data);
      } else {
        $('#interfaceDetail').html(`
          <div class="alert alert-danger" role="alert">
            加载接口详情失败：${res.msg || '未知错误'}
          </div>
        `);
      }
    },
    error: function (err) {
      $('#interfaceDetail').html(`
        <div class="alert alert-danger" role="alert">
          加载接口详情失败，请重试
        </div>
      `);
      console.error('加载接口详情出错：', err);
    }
  });
}
function renderInterfaceDetail(iface) {
  const headerTable = iface.header_params.length > 0
    ? `
    <div class="mb-3">
      <h6 class="fw-bold">请求头参数</h6>
      <table class="table table-sm table-bordered">
        <thead>
          <tr>
            <th style="width: 8em;">参数名</th>
            <th style="width: 8em;">数据类型</th>
            <th style="width: 8em;">是否必填</th>
            <th style="width: 28em;">示例值</th>
          </tr>
        </thead>
        <tbody>
          ${iface.header_params.map(param => `
          <tr>
            <td>${param.param_name}</td>
            <td>${param.data_type}</td>
            <td>${param.is_required ? "是" : "否"}</td>
            <td>${param.example_value}</td>
          </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
    `
    : '<div class="mb-3 text-muted">无请求头参数</div>';
  const requestTable = iface.request_params.length > 0
    ? `
    <div class="mb-3">
      <h6 class="fw-bold">请求参数</h6>
      <table class="table table-sm table-bordered">
        <thead>
          <tr>
            <th style="width: 8em;">参数名</th>
            <th style="width: 8em;">数据类型</th>
            <th style="width: 8em;">是否必填</th>
            <th style="width: 28em;">示例值</th>
          </tr>
        </thead>
        <tbody>
          ${iface.request_params.map(param => `
          <tr>
            <td>${param.param_name}</td>
            <td>${param.data_type}</td>
            <td>${param.is_required ? "是" : "否"}</td>
            <td>${param.example_value}</td>
          </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
    `
    : '<div class="mb-3 text-muted">无请求参数</div>';
  const responseTable = iface.response_params.length > 0
    ? `
    <div class="mb-3">
      <h6 class="fw-bold">响应结果参数</h6>
      <table class="table table-sm table-bordered">
        <thead>
          <tr>
            <th style="width: 8em;">参数名</th>
            <th style="width: 8em;">数据类型</th>
            <th style="width: 8em;">是否必填</th>
            <th style="width: 28em;">示例值</th>
          </tr>
        </thead>
        <tbody>
          ${iface.response_params.map(param => `
          <tr>
            <td>${param.param_name}</td>
            <td>${param.data_type}</td>
            <td>${param.is_required ? "是" : "否"}</td>
            <td>${param.example_value}</td>
          </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
    `
    : '<div class="mb-3 text-muted">无响应结果参数</div>';
  const detailHtml = `
    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">${iface.name}</h5>
        <span class="badge bg-${
          iface.method === "GET"
            ? "info"
            : iface.method === "POST"
            ? "success"
            : iface.method === "PUT"
            ? "warning"
            : "danger"
        }">${iface.method}</span>
      </div>
      <div class="card-body">
        <div class="mb-4 d-flex gap-2">
          <button class="btn btn-sm btn-primary" onclick="openEditPage(${iface.interface_id})">编辑接口</button>
          <button class="btn btn-sm btn-success" onclick="testInterface(${iface.interface_id})">测试接口</button>
          <button class="btn btn-sm btn-secondary" onclick="openDependencyConfig(${iface.interface_id})">
             依赖配置
          </button>
          <button class="btn btn-sm btn-danger" onclick="deleteInterface(${iface.interface_id})">删除接口</button>
        </div>
        <div class="mb-3">
          <h6 class="fw-bold">请求 URL</h6>
          <p class="text-break">${iface.url}</p>
        </div>
        ${headerTable}
        ${requestTable}
        ${responseTable}
      </div>
    </div>
  `;
  $("#interfaceDetail").html(detailHtml);
}
function openEditPage(interfaceId) {
  window.location.href = `/interface/edit/${interfaceId}`;
}
function testInterface(interfaceId) {
  alert(`测试接口 ID: ${interfaceId}`);
}
function deleteInterface(interfaceId) {
  if (confirm('确定删除该接口吗？此操作不可恢复！')) {
    $.ajax({
      url: `/api/interface/${interfaceId}`,
      type: 'DELETE',
      success: function (res) {
        if (res.code === 200) {
          alert('删除成功');
          loadProjectTree();
          $('#interfaceDetail').html(`
            <h5 class="fw-bold mb-4">请选择左侧接口查看详情</h5>
            <div class="alert alert-info" role="alert">
              从左侧项目列表中展开项目，点击接口名称以查看详情
            </div>
          `);
        } else {
          alert('删除失败：' + res.msg);
        }
      },
      error: function (err) {
        alert('删除接口失败，请重试');
        console.error('删除接口出错：', err);
      }
    });
  }
}
// 打开依赖配置页面
function openDependencyConfig(interfaceId) {
  window.open(`/interface/dependency/config?interface_id=${interfaceId}`,
              '接口依赖配置',
              'width=1000,height=700,top=100,left=200');
}
// 为更新项目按钮绑定点击事件
$(document).on('click', '.update-project', function () {
    const projectId = $(this).data('project-id');
    // 创建隐藏的文件上传输入框
    let fileInput = $('<input type="file" style="display:none">');
    $('body').append(fileInput);
    fileInput.click();
    fileInput.on('change', function () {
        if (this.files.length > 0) {
            let formData = new FormData();
            formData.append('file', this.files[0]);
            formData.append('project_id', projectId);
            $.ajax({
                url: '/api/project/update',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function (res) {
                    if (res.code === 200) {
                        alert('项目接口更新成功');
                        // 重新加载项目列表和接口信息
                        loadProjectTree();
                    } else {
                        alert('项目接口更新失败：' + res.msg);
                    }
                },
                error: function (err) {
                    alert('项目接口更新请求失败，请重试');
                    console.error('更新项目接口出错：', err);
                }
            });
        }
        fileInput.remove();
    });
});
// 为删除项目按钮绑定点击事件
$(document).on('click', '.delete-project', function () {
    const projectId = $(this).data('project-id');
    if (confirm('确定删除该项目吗？此操作不可恢复！')) {
        console.log('删除项目按钮被点击，项目ID:', projectId);
        // 删除项目的AJAX请求逻辑
        $.ajax({
            url: `/api/projects/${projectId}`, // 后端删除项目的接口地址
            type: 'DELETE',
            success: function (res) {
                if (res.code === 200) {
                    alert('项目删除成功');
                    // 重新加载项目列表
                    loadProjectTree();
                } else {
                    alert('项目删除失败：' + res.msg);
                }
            },
            error: function (err) {
                alert('项目删除请求失败，请重试');
                console.error('删除项目出错：', err);
            }
        });
    }
});
</script>
{% endblock %}