{% extends "index.html" %}
{% block content %}
<div class="container-fluid p-0" style="height: 100vh;">
  <div class="row g-0 h-100">
    <!-- 左侧项目树 -->
    <div class="col-lg-3 bg-light border-end h-100 overflow-auto">
      <div class="p-3">
        <h5 class="fw-bold mb-3">项目列表</h5>
        <ul class="list-unstyled" id="projectTree">
          <li class="text-muted">加载项目中...</li>
        </ul>
      </div>
    </div>
    <!-- 右侧用例列表 -->
    <div class="col-lg-9 h-100 overflow-auto bg-white">
      <div class="p-4" id="caseContainer">
        <!-- 初始状态提示 -->
        <div class="alert alert-info" id="initialPrompt">
          <i class="bi bi-info-circle"></i> 从左侧项目列表选中项目展示项目下的测试用例
        </div>
        <!-- 用例列表（默认隐藏） -->
        <div id="caseListSection" style="display: none;">
          <h5 class="fw-bold mb-4">
            <span id="selectedProjectName">测试用例</span>
          </h5>
          <!-- 表格容器添加滚动条以处理宽表格 -->
          <div style="overflow-x: auto;">
            <table class="table table-striped" id="caseTable">
              <thead>
                <tr>
                  <th style="width: 4em;">ID</th>
                  <th style="width: 8em;">用例名称</th>
                  <th style="width: 8em;">请求头参数</th>
                  <th style="width: 8em;">请求参数</th>
                  <th style="width: 10em;">预期结果</th>
                  <th style="width: 8em;">判定规则</th>
                  <th style="min-width: 18em;">操作</th>
                </tr>
              </thead>
              <tbody id="caseTbody">
                <!-- 用例数据将动态填充 -->
              </tbody>
            </table>
          </div>
          <!-- 无测试用例提示（默认隐藏） -->
          <div class="alert alert-warning" id="noCasePrompt" style="display: none;">
            <i class="bi bi-exclamation-triangle"></i> 该项目暂无测试用例，请点击"测试用例生成"按钮生成
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
  console.log('test_case_management 页面 - 项目与用例逻辑执行');

  // DOM元素
  const projectTree = document.getElementById('projectTree');
  const caseContainer = document.getElementById('caseContainer');
  const initialPrompt = document.getElementById('initialPrompt');
  const caseListSection = document.getElementById('caseListSection');
  const selectedProjectName = document.getElementById('selectedProjectName');
  const caseTable = document.getElementById('caseTable');
  const caseTbody = document.getElementById('caseTbody');
  const noCasePrompt = document.getElementById('noCasePrompt');

  // 状态变量
  let selectedProject = null; // 记录当前选中的项目 {id, name}
  let projectTestCases = {}; // 缓存已生成的用例 {projectId: cases[]}
  let projectList = []; // 存储项目列表数据

  // 验证DOM元素
  if (!projectTree ||!caseContainer) {
    console.error('关键 DOM 元素缺失');
    return;
  }

  // 格式化参数显示（转换为"参数:参数值"格式）
  const formatParams = (paramsStr) => {
    if (!paramsStr || paramsStr === '无') return paramsStr;
    // 处理可能的多种分隔符情况
    const paramPairs = paramsStr.split(/[,;]/).map(pair => {
      // 分割参数名和参数值（处理可能的空格）
      const parts = pair.split(/:\s*/);
      if (parts.length === 2) {
        return `${parts[0].trim()}:${parts[1].trim()}`;
      }
      return pair.trim();
    });
    return paramPairs.join('; ');
  };

  // 加载项目列表
  const loadProjects = () => {
    const xhr = new XMLHttpRequest();
    xhr.open('GET', '/api/all-projects', true);
    xhr.timeout = 10000;
    xhr.onloadstart = () => {
      projectTree.innerHTML = '<li class="text-muted">正在加载项目...</li>';
    };
    xhr.onload = function () {
      if (xhr.status === 200) {
        try {
          const res = JSON.parse(xhr.responseText);
          projectTree.innerHTML = '';
          if (res && res.code === 200 && Array.isArray(res.data)) {
            projectList = res.data; // 存储项目列表
            res.data.forEach(project => {
              const li = document.createElement('li');
              li.className ='mb-3 project-item';
              li.dataset.projectId = project.id;
              li.innerHTML = `
                <div class="d-flex justify-content-between align-items-center p-2 rounded border shadow-sm">
                  <span class="fw-medium project-name">${project.name || '未知项目'}</span>
                  <button class="btn btn-sm btn-primary generate-btn"
                          onclick="handleGenerateCases(${project.id}, '${project.name || '未知项目'}', this)">
                    测试用例生成
                  </button>
                </div>
              `;
              // 点击项目名称选中项目
              li.querySelector('.project-name').addEventListener('click', function () {
                selectProject(project.id, project.name);
              });
              projectTree.appendChild(li);
            });
          } else {
            projectTree.innerHTML = '<li class="text-danger list-group-item">项目数据格式错误</li>';
          }
        } catch (e) {
          projectTree.innerHTML = '<li class="text-danger list-group-item">项目数据解析错误</li>';
          console.error('项目数据解析失败:', e);
        }
      } else {
        projectTree.innerHTML = `<li class="text-danger list-group-item">项目请求失败，状态码: ${xhr.status}</li>`;
      }
    };
    xhr.onerror = () => {
      projectTree.innerHTML = '<li class="text-danger list-group-item">项目请求网络错误</li>';
    };
    xhr.ontimeout = () => {
      projectTree.innerHTML = '<li class="text-danger list-group-item">项目请求超时</li>';
    };
    xhr.send();
  };

  // 选中项目
  window.selectProject = function (projectId, projectName) {
    // 更新选中状态
    document.querySelectorAll('.project-item').forEach(item => {
      item.classList.remove('active');
    });
    const selectedItem = document.querySelector(`.project-item[data-project-id="${projectId}"]`);
    if (selectedItem) {
      selectedItem.classList.add('active');
    }

    // 更新状态变量
    selectedProject = { id: projectId, name: projectName };
    selectedProjectName.textContent = `${projectName} - 测试用例`;

    // 切换显示区域
    initialPrompt.style.display = 'none';
    caseListSection.style.display = 'block';

    // 检查是否有缓存的用例
    if (projectTestCases[projectId]) {
      renderTestCases(projectTestCases[projectId]);
    } else {
      // 显示加载状态
      caseTbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted"><i class="bi bi-hourglass"></i> 加载用例中...</td></tr>';
      noCasePrompt.style.display = 'none';
      // 尝试从服务器加载已存在的用例
      loadExistingCases(projectId);
    }
  };

  // 加载已存在的用例
  const loadExistingCases = (projectId) => {
    // 从项目列表中获取项目信息
    const project = projectList.find(p => p.id === projectId);
    if (!project) {
      console.error('项目不存在');
      caseTbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">项目不存在</td></tr>';
      return;
    }

    // 如果项目没有接口信息，直接显示无数据
    if (!project.interfaces ||!Array.isArray(project.interfaces)) {
      projectTestCases[projectId] = [];
      renderTestCases([]);
      return;
    }

    // 为每个接口创建获取用例的Promise
    const casePromises = project.interfaces.map(interface => {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', `/api/interface/${interface.interface_id}/cases`, true);
        xhr.timeout = 10000;

        xhr.onload = function () {
          if (xhr.status === 200) {
            try {
              const res = JSON.parse(xhr.responseText);
              resolve(Array.isArray(res)? res : []);
            } catch (e) {
              console.error('用例数据解析失败:', e);
              resolve([]);
            }
          } else if (xhr.status === 404) {
            resolve([]);
          } else {
            console.error('加载用例失败，状态码:', xhr.status);
            resolve([]);
          }
        };

        xhr.onerror = function () {
          console.error('加载用例网络错误');
          resolve([]);
        };

        xhr.ontimeout = function () {
          console.error('加载用例超时');
          resolve([]);
        };

        xhr.send();
      });
    });

    // 等待所有接口用例加载完成
    Promise.all(casePromises)
     .then(results => {
        const allCases = [].concat(...results);
        projectTestCases[projectId] = allCases;
        renderTestCases(allCases);
      })
     .catch(error => {
        console.error('加载用例失败:', error);
        caseTbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">加载用例失败: ${error.message}</td></tr>`;
        noCasePrompt.style.display = 'none';
      });
  };

  // 生成测试用例
  window.handleGenerateCases = function (projectId, projectName, btn) {
    // 先选中项目
    selectProject(projectId, projectName);

    // 显示生成中状态
    caseTbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted"><i class="bi bi-hourglass"></i> 生成测试用例中...</td></tr>';
    noCasePrompt.style.display = 'none';

    // 禁用生成按钮防止重复提交
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 生成中...';

    const xhr = new XMLHttpRequest();
    xhr.open('GET', `/api/project/${projectId}/generate_cases`, true);
    xhr.timeout = 15000;

    xhr.onload = function () {
      // 恢复按钮状态
      btn.disabled = false;
      btn.innerHTML = '测试用例生成';

      if (xhr.status === 200) {
        try {
          const res = JSON.parse(xhr.responseText);
          if (res && Array.isArray(res)) {
            // 缓存生成的用例
            projectTestCases[projectId] = res;
            renderTestCases(res);
          } else {
            caseTbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">用例数据格式错误</td></tr>';
          }
        } catch (e) {
          caseTbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">用例数据解析错误</td></tr>';
          console.error('用例数据解析失败:', e);
        }
      } else {
        caseTbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">生成用例失败，状态码: ${xhr.status}</td></tr>`;
      }
    };

    xhr.onerror = () => {
      // 恢复按钮状态
      btn.disabled = false;
      btn.innerHTML = '测试用例生成';
      caseTbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">生成用例网络错误</td></tr>';
    };

    xhr.ontimeout = () => {
      // 恢复按钮状态
      btn.disabled = false;
      btn.innerHTML = '测试用例生成';
      caseTbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">生成用例超时</td></tr>';
    };

    xhr.send();
  };

  // 执行测试用例
  window.runCase = function (caseId) {
    console.log(`执行测试用例: ${caseId}`);
    // 显示执行状态
    const row = document.querySelector(`tr:has(td:first-child:contains('${caseId}'))`);
    if (row) {
      const originalHtml = row.cells[6].innerHTML;
      row.cells[6].innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 执行中...';

      // 模拟执行请求
      setTimeout(() => {
        alert(`测试用例 ${caseId} 执行完成`);
        row.cells[6].innerHTML = originalHtml;
      }, 1000);
    }
  };

  // 编辑测试用例
  window.editCase = function (caseId) {
    console.log(`编辑测试用例: ${caseId}`);
    // 编辑用例的逻辑实现
    alert(`正在编辑用例 ${caseId}`);
  };

  // 删除测试用例
  window.deleteCase = function (caseId) {
    console.log(`删除测试用例: ${caseId}`);
    // 删除用例的逻辑实现
    if (confirm(`确定要删除用例 ${caseId} 吗？`)) {
      // 发送删除请求
      const xhr = new XMLHttpRequest();
      xhr.open('DELETE', `/api/case/${caseId}`, true);

      xhr.onload = function () {
        if (xhr.status === 200) {
          alert(`用例 ${caseId} 已删除`);
          // 重新加载列表
          if (selectedProject) {
            loadExistingCases(selectedProject.id);
          }
        } else {
          alert(`删除失败，状态码: ${xhr.status}`);
        }
      };

      xhr.onerror = function () {
        alert('删除请求网络错误');
      };

      xhr.send();
    }
  };

  // 渲染测试用例列表
  function renderTestCases(cases) {
    const tbody = document.getElementById('caseTbody');
    tbody.innerHTML = '';

    if (cases.length === 0) {
      document.getElementById('noCasePrompt').style.display = 'block';
      return;
    }

    document.getElementById('noCasePrompt').style.display = 'none';

    cases.forEach(caseItem => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${caseItem.case_id}</td>
        <td>${caseItem.case_name || '-'}</td>
        <td>${formatParams(caseItem.request_header) || '-'}</td>
        <td>${formatParams(caseItem.request_param) || '-'}</td>
        <td>${caseItem.expected_result || '-'}</td>
        <td>${caseItem.assert_rule || '-'}</td>
        <td>
          <button class="btn btn-sm btn-warning" onclick="editCase(${caseItem.case_id})">编辑</button>
          <button class="btn btn-sm btn-danger" onclick="deleteCase(${caseItem.case_id})">删除</button>
          <button class="btn btn-sm btn-primary" onclick="runCase(${caseItem.case_id})">执行</button>
        </td>
      `;
      tbody.appendChild(row);
    });
  }

  // 初始化加载项目
  loadProjects();
});
</script>
<style>
  /* 项目项基础样式 */
  .project-item {
    list-style: none;
    background-color: #fff;
    border: 1px solid #ddd;
    transition: all 0.2s ease;
  }

  /* 项目选中态样式 - 提高选择器优先级 */
  .project-item.active {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
  }

  /* 选中态下的文字样式 */
  .project-item.active .project-name {
    color: #ffffff !important;
    font-weight: bold;
  }

  /* 选中态下的按钮样式 */
  .project-item.active .generate-btn {
    background-color: #ffffff !important;
    color: #0d6efd !important;
    border-color: #ffffff !important;
  }

  /* 项目名称点击区域样式 */
  .project-name {
    cursor: pointer;
    padding: 2px 5px;
    border-radius: 3px;
    color: #212529; /* 默认文字颜色 */
  }

  .project-name:hover {
    background-color: rgba(13, 110, 253, 0.1);
  }

  /* 表格强制按列宽布局 */
  #caseTable {
    table-layout: fixed; /* 关键：强制表格按列宽布局 */
    width: 100%; /* 设置表格宽度为100%，使其适应容器 */
  }

  /* 表格单元格样式：除操作列外，其他列都设置截断和省略号 */
  #caseTable th:not(:nth-child(7)),
  #caseTable td:not(:nth-child(7)) {
    white-space: nowrap; /* 强制不换行 */
    overflow: hidden;    /* 溢出隐藏 */
    text-overflow: ellipsis; /* 溢出显示省略号 */
    vertical-align: middle;
  }

  /* 各列宽度设置 */
  #caseTable th:nth-child(1), #caseTable td:nth-child(1) {
    width: 4em;
  }
  #caseTable th:nth-child(2), #caseTable td:nth-child(2) {
    width: 6em;
  }
  #caseTable th:nth-child(3), #caseTable td:nth-child(3) {
    width: 6em;
  }
  #caseTable th:nth-child(4), #caseTable td:nth-child(4) {
    width: 6em;
  }
  #caseTable th:nth-child(5), #caseTable td:nth-child(5) {
    width: 12em;
  }
  #caseTable th:nth-child(6), #caseTable td:nth-child(6) {
    width: 6em;
  }
  #caseTable th:nth-child(7), #caseTable td:nth-child(7) {
    min-width: 16em;
  }
</style>
{% endblock %}