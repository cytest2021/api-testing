{% extends "index.html" %}
{% block content %}
<div class="container-fluid p-0" style="height: 100vh;">
  <div class="row g-0 h-100">
    <!-- 左侧项目树 -->
    <div class="col-lg-3 bg-light border-end h-100 overflow-auto">
      <div class="p-3">
        <h5 class="fw-bold mb-3">项目列表</h5>
        <ul class="list-unstyled" id="projectTree">
          <li class="text-muted">加载项目中...</li>
        </ul>
      </div>
    </div>
    <!-- 右侧用例列表 -->
    <div class="col-lg-9 h-100 overflow-auto bg-white">
      <div class="p-4" id="caseContainer">
        <!-- 初始状态提示 -->
        <div class="alert alert-info" id="initialPrompt">
          <i class="bi bi-info-circle"></i> 从左侧项目列表选中项目展示项目下的测试用例
        </div>
        <!-- 用例列表（默认隐藏） -->
        <div id="caseListSection" style="display: none;">
          <h5 class="fw-bold mb-4">
            <span id="selectedProjectName">测试用例</span>
            <!-- 新增导出按钮 -->
            <button class="btn btn-danger" onclick="exportSelectedCases()">导出</button>
          </h5>
          <!-- 表格容器添加滚动条以处理宽表格 -->
          <div style="overflow-x: auto;">
            <table class="table table-striped" id="caseTable">
              <thead>
                <tr>
                  <th style="width: 3em;">
                    <input type="checkbox" id="selectAll" onclick="toggleSelectAll()">
                  </th>
                  <th style="width: 4em;">ID</th>
                  <th style="width: 8em;">用例名称</th>
                  <th style="width: 8em;">请求头参数</th>
                  <th style="width: 8em;">请求参数</th>
                  <th style="width: 10em;">预期结果</th>
                  <th style="width: 8em;">判定规则</th>
                  <th style="min-width: 18em;">操作</th>
                </tr>
              </thead>
              <tbody id="caseTbody">
                <!-- 用例数据将动态填充 -->
              </tbody>
            </table>
          </div>
          <!-- 无测试用例提示（默认隐藏） -->
          <div class="alert alert-warning" id="noCasePrompt" style="display: none;">
            <i class="bi bi-exclamation-triangle"></i> 该项目暂无测试用例，请点击"测试用例生成"按钮生成
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
  console.log('test_case_management页面 - 项目与用例逻辑执行');
  // DOM元素
  const projectTree = document.getElementById('projectTree');
  const caseContainer = document.getElementById('caseContainer');
  const initialPrompt = document.getElementById('initialPrompt');
  const caseListSection = document.getElementById('caseListSection');
  const selectedProjectName = document.getElementById('selectedProjectName');
  const caseTable = document.getElementById('caseTable');
  const caseTbody = document.getElementById('caseTbody');
  const noCasePrompt = document.getElementById('noCasePrompt');
  // 状态变量
  let selectedProject = null; // 记录当前选中的项目 {id, name}
  let projectTestCases = {}; // 缓存已生成的用例 {projectId: cases[]}
  let projectList = []; // 存储项目列表数据
  // 验证DOM元素
  if (!projectTree ||!caseContainer) {
    console.error('关键DOM元素缺失');
    return;
  }
  // ===================== 修改：判定规则中英文映射表 =====================
  const assertRuleMap = {
      'status: true': '校验响应状态码',
       'code: true': '校验业务码（code字段）',
       'body: true': '校验完整响应体',
       // 修改：明确“校验响应体指定参数”的展示格式
       'body_param: true': '校验响应体指定参数：{param_name}'
    };
// ===================== 修改：规则解析函数（关键逻辑） =====================
    const parseAssertRule = (ruleStr) => {
        if (!ruleStr || ruleStr === '无' || ruleStr === '-') return '无';
        try {
            const ruleObj = JSON.parse(ruleStr);
            let chineseRules = [];

            // 1. 遍历规则，仅保留“校验项”（value为true的规则），过滤“不校验项”（value为false）
            for (const [key, value] of Object.entries(ruleObj)) {
                // 跳过“不校验”的规则（value为false）和冗余的body_param_path字段
                if (value === false || key === 'body_param_path') {
                    continue;
                }

                const ruleKey = `${key}: ${value}`;
                let mappedRule = assertRuleMap[ruleKey];

                // 2. 处理“校验响应体指定参数”：合并参数名，不单独展示body_param_path
                if (key === 'body_param' && value === true) {
                    // 从规则对象中获取用户填写的参数名（body_param_path存储参数名）
                    const paramName = ruleObj.body_param_path || '未填写';
                    mappedRule = `校验响应体指定参数：${paramName}`; // 直接拼接参数名，不冗余展示
                }

                // 将处理后的规则加入列表（无映射时保留原始规则）
                if (mappedRule) {
                    chineseRules.push(mappedRule);
                } else if (value === true) {
                    // 兼容未配置映射的校验项（仅保留true的规则）
                    chineseRules.push(`${key}（校验）`);
                }
            }

            // 若没有需要展示的规则，返回“无”
            return chineseRules.length > 0 ? chineseRules.join('<br>') : '无';
        } catch (error) {
            console.warn('判定规则解析失败（非JSON）:', error, '原始规则:', ruleStr);
            return ruleStr;
        }
    };

  // 格式化参数显示（转换为"参数:参数值"格式）
  const formatParams = (paramsStr) => {
      if (!paramsStr || paramsStr === '无') return paramsStr;
      try {
          const params = JSON.parse(paramsStr);
          const paramPairs = [];
          for (const [key, value] of Object.entries(params)) {
              paramPairs.push(`${key}: ${value}`);
          }
          return paramPairs.join('; ');
      } catch (error) {
          // 如果解析失败，返回原始字符串
          return paramsStr;
      }
  };
  // 加载项目列表
  const loadProjects = () => {
    const xhr = new XMLHttpRequest();
    xhr.open('GET', '/api/all-projects', true);
    xhr.timeout = 10000;
    xhr.onloadstart = () => {
      projectTree.innerHTML = '<li class="text-muted">正在加载项目...</li>';
    };
    xhr.onload = function () {
      if (xhr.status === 200) {
        try {
          const res = JSON.parse(xhr.responseText);
          projectTree.innerHTML = '';
          if (res && res.code === 200 && Array.isArray(res.data)) {
            projectList = res.data; // 存储项目列表
            res.data.forEach(project => {
              const li = document.createElement('li');
              li.className ='mb-3 project-item';
              li.dataset.projectId = project.id;
              li.innerHTML = `
                <div class="d-flex justify-content-between align-items-center p-2 rounded border shadow-sm">
                  <span class="fw-medium project-name">${project.name || '未知项目'}</span>
                  <button class="btn btn-sm btn-primary generate-btn"
                          onclick="handleGenerateCases(${project.id}, '${project.name || '未知项目'}', this)">
                    测试用例生成
                  </button>
                </div>
              `;
              // 点击项目名称选中项目
              li.querySelector('.project-name').addEventListener('click', function () {
                selectProject(project.id, project.name);
              });
              projectTree.appendChild(li);
            });
          } else {
            projectTree.innerHTML = '<li class="text-danger list-group-item">项目数据格式错误</li>';
          }
        } catch (e) {
          projectTree.innerHTML = '<li class="text-danger list-group-item">项目数据解析错误</li>';
          console.error('项目数据解析失败:', e);
        }
      } else {
        projectTree.innerHTML = `<li class="text-danger list-group-item">项目请求失败，状态码: ${xhr.status}</li>`;
      }
    };
    xhr.onerror = () => {
      projectTree.innerHTML = '<li class="text-danger list-group-item">项目请求网络错误</li>';
    };
    xhr.ontimeout = () => {
      projectTree.innerHTML = '<li class="text-danger list-group-item">项目请求超时</li>';
    };
    xhr.send();
  };
  // 选中项目
  window.selectProject = function (projectId, projectName) {
    // 更新选中状态
    document.querySelectorAll('.project-item').forEach(item => {
      item.classList.remove('active');
    });
    const selectedItem = document.querySelector(`.project-item[data-project-id="${projectId}"]`);
    if (selectedItem) {
      selectedItem.classList.add('active');
    }
    // 更新状态变量
    selectedProject = { id: projectId, name: projectName };
    selectedProjectName.textContent = `${projectName} - 测试用例`;
    // 切换显示区域
    initialPrompt.style.display = 'none';
    caseListSection.style.display = 'block';
    // 检查是否有缓存的用例
    if (projectTestCases[projectId]) {
      renderTestCases(projectTestCases[projectId]);
    } else {
      // 显示加载状态
      caseTbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted"><i class="bi bi-hourglass"></i> 加载用例中...</td></tr>';
      noCasePrompt.style.display = 'none';
      // 尝试从服务器加载已存在的用例
      loadExistingCases(projectId);
    }
  };
  // 替换原 loadExistingCases 函数
  const loadExistingCases = (projectId) => {
    // 从项目列表中获取项目信息
    const project = projectList.find(p => p.id === projectId);
    if (!project) {
      console.error('项目不存在');
      caseTbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">项目不存在</td></tr>';
      return;
    }
    // 显示加载状态
    caseTbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted"><i class="bi bi-hourglass"></i> 加载用例中...</td></tr>';
    noCasePrompt.style.display = 'none';
    // 直接调用项目级用例接口
    const xhr = new XMLHttpRequest();
    xhr.open('GET', `/api/project/${projectId}/cases`, true);
    xhr.timeout = 10000;
    xhr.onload = function () {
      if (xhr.status === 200) {
        try {
          const res = JSON.parse(xhr.responseText);
          if (res.code === 200 && Array.isArray(res.data)) {
            // 按照id排序
            const sortedCases = res.data.sort((a, b) => a.case_id - b.case_id);
            const allCases = sortedCases;
            projectTestCases[projectId] = allCases;
            if (allCases.length > 0) {
              renderTestCases(allCases);
              noCasePrompt.style.display = 'none';
            } else {
              renderTestCases([]);
              noCasePrompt.style.display = 'block';
            }
          } else {
            caseTbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">用例数据格式错误</td></tr>';
          }
        } catch (e) {
          console.error('用例数据解析失败:', e);
          caseTbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">用例数据解析错误</td></tr>';
        }
      } else {
        caseTbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">加载用例失败，状态码: ${xhr.status}</td></tr>`;
      }
    };
    xhr.onerror = function () {
      console.error('加载用例网络错误');
      caseTbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">加载用例网络错误</td></tr>';
    };
    xhr.ontimeout = function () {
      console.error('加载用例超时');
      caseTbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">加载用例超时</td></tr>';
    };
    xhr.send();
  };
  // 生成测试用例
  window.handleGenerateCases = function (projectId, projectName, btn) {
    // 先选中项目
    selectProject(projectId, projectName);
    // 显示生成中状态
    caseTbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted"><i class="bi bi-hourglass"></i> 生成测试用例中...</td></tr>';
    noCasePrompt.style.display = 'none';
    // 禁用生成按钮防止重复提交
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 生成中...';
    const xhr = new XMLHttpRequest();
    xhr.open('GET', `/api/project/${projectId}/generate_cases`, true);
    xhr.timeout = 15000;
    xhr.onload = function () {
      // 恢复按钮状态
      btn.disabled = false;
      btn.innerHTML = '测试用例生成';
      if (xhr.status === 200) {
        try {
          const res = JSON.parse(xhr.responseText);
          if (res && Array.isArray(res)) {
            // 按照id排序
            const sortedCases = res.sort((a, b) => a.case_id - b.case_id);
            // 直接更新前端用例列表
            renderTestCases(sortedCases);
            projectTestCases[projectId] = sortedCases;
          } else {
            caseTbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">用例数据格式错误</td></tr>';
          }
        } catch (e) {
          caseTbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">用例数据解析错误</td></tr>';
          console.error('用例数据解析失败:', e);
        }
      } else {
        caseTbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">生成用例失败，状态码: ${xhr.status}</td></tr>`;
      }
    };
    xhr.onerror = () => {
      // 恢复按钮状态
      btn.disabled = false;
      btn.innerHTML = '测试用例生成';
      caseTbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">生成用例网络错误</td></tr>';
    };
    xhr.ontimeout = () => {
      // 恢复按钮状态
      btn.disabled = false;
      btn.innerHTML = '测试用例生成';
      caseTbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">生成用例超时</td></tr>';
    };
    xhr.send();
  };

  // 复制测试用例
  // 修复后的复制用例函数
  // 复制测试用例（修改后与编辑/删除获取ID方式一致）
window.copyCase = function (btn) {
    // 从按钮获取真实的用例ID（与编辑/删除逻辑一致）
    const realCaseId = btn.getAttribute('data-case-id');
    console.log(`复制测试用例: ${realCaseId}`);

    // 查找对应的行（遍历表格行，通过按钮的data-case-id属性匹配）
    const rows = document.querySelectorAll('#caseTbody tr');
    let targetRow = null;
    rows.forEach(row => {
        const copyBtn = row.querySelector('button[data-case-id]');
        if (copyBtn && copyBtn.getAttribute('data-case-id') === realCaseId) {
            targetRow = row;
        }
    });

    if (targetRow) {
        const originalHtml = targetRow.cells[6].innerHTML;
        targetRow.cells[6].innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 复制中...';
        fetch(`/api/case/${realCaseId}/copy`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            targetRow.cells[6].innerHTML = originalHtml;
            if (data.code === 200) {
                alert(`用例复制成功，新用例ID: ${data.data.new_case_id}`);
                if (selectedProject) {
                    loadExistingCases(selectedProject.id);
                }
            } else {
                alert(`复制失败: ${data.message || '未知错误'}`);
            }
        })
        .catch(error => {
            targetRow.cells[6].innerHTML = originalHtml;
            console.error('复制用例请求失败:', error);
            alert('复制请求网络错误');
        });
    } else {
        console.error(`未找到ID为${realCaseId}的用例行`);
        alert('未找到对应的测试用例');
    }
  };

  // 添加获取Cookie的辅助函数（如果需要CSRF令牌）
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  // 编辑测试用例
  window.editCase = function (btn) {
    // 从按钮的 data-case-id 属性获取真实用例 ID
    const realCaseId = btn.getAttribute('data-case-id');
    console.log(`编辑测试用例（真实 ID）: ${realCaseId}`);

    // 拼接正确的编辑页面 URL
    const editUrl = `/case/edit/${realCaseId}`;
    window.location.href = editUrl;
  };

  // 删除测试用例
  window.deleteCase = function (btn) {
    // 从按钮的 data-case-id 属性获取真实用例 ID
    const realCaseId = btn.getAttribute('data-case-id');
    console.log(`删除测试用例（真实 ID）: ${realCaseId}`);

    // 弹出确认提示，显示真实用例 ID
    if (confirm(`确定要删除用例 ${realCaseId} 吗？`)) {
        // 发起删除请求
        fetch(`/api/case/${realCaseId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.code === 200) {
                alert(`用例 ${realCaseId} 已删除`);
                // 重新加载当前项目用例（与原有逻辑一致）
                if (selectedProject) {
                    loadExistingCases(selectedProject.id);
                }
            } else {
                alert(`删除失败: ${data.message || '未知错误'}`);
            }
        })
        .catch(error => {
            console.error('删除用例请求失败:', error);
            alert('删除请求网络错误');
        });
    }
  };
  // 全选/反选逻辑（如果有表格全选需求，补充如下）
  window.toggleSelectAll = function () {
      const selectAllCheckbox = document.getElementById('selectAll');
      const caseCheckboxes = document.querySelectorAll('.caseCheckbox');
      caseCheckboxes.forEach(checkbox => {
          checkbox.checked = selectAllCheckbox.checked;
      });
  };

  // 导出选中用例到 Excel 逻辑
  window.exportSelectedCases = function () {
    const selectedCaseIds = [];
    const caseCheckboxes = document.querySelectorAll('.caseCheckbox:checked');
    caseCheckboxes.forEach(checkbox => {
        selectedCaseIds.push(checkbox.getAttribute('data-case-id'));
    });
    if (selectedCaseIds.length === 0) {
        alert('请至少选择一个测试用例进行导出');
        return;
    }
    // 调用后端导出接口
    fetch('/api/export-cases', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ case_ids: selectedCaseIds })
    })
   .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('导出失败');
    })
   .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'test_cases.xlsx';
        a.click();
        window.URL.revokeObjectURL(url);
    })
   .catch(error => {
        console.error('导出用例请求失败:', error);
        alert('导出请求网络错误，请重试');
    });
  };

// 渲染测试用例列表（修改：确保判定规则正确展示）
// 渲染测试用例列表（修改：修正请求头/请求参数字段名）
function renderTestCases(cases) {
    const tbody = document.getElementById('caseTbody');
    tbody.innerHTML = '';
    if (cases.length === 0) {
        document.getElementById('noCasePrompt').style.display = 'block';
        return;
    }
    document.getElementById('noCasePrompt').style.display = 'none';
    cases.forEach((caseItem, index) => {
        const fakeId = index + 1;
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="checkbox" class="caseCheckbox" data-case-id="${caseItem.case_id}"></td>
            <td>${fakeId}</td>
            <td>${caseItem.case_name || '-'}</td>
            <!-- 关键修改：将 request_header_params 改为 request_header -->
            <td>${formatParams(caseItem.request_header) || '-'}</td>
            <!-- 关键修改：将 request_params 改为 request_param -->
            <td>${formatParams(caseItem.request_param) || '-'}</td>
            <td>${formatParams(caseItem.expected_result) || '-'}</td>
            <td>${parseAssertRule(caseItem.assert_rule) || '-'}</td>
            <td>
                <button class="btn btn-sm btn-warning" data-case-id="${caseItem.case_id}" onclick="editCase(this)">编辑</button>
                <button class="btn btn-sm btn-secondary" data-case-id="${caseItem.case_id}" onclick="copyCase(this)">复制</button>
                <button class="btn btn-sm btn-danger" data-case-id="${caseItem.case_id}" onclick="deleteCase(this)">删除</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

  // 初始化加载项目
  loadProjects();
});
</script>
<style>
  /* 项目项基础样式 */
  .project-item {
    list-style: none;
    background-color: #fff;
    border: 1px solid #ddd;
    transition: all 0.2s ease;
  }
  /* 项目选中态样式 - 提高选择器优先级 */
  .project-item.active {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
  }

  /* 选中态下的文字样式 */
  .project-item.active .project-name {
    color: #ffffff !important;
    font-weight: bold;
  }

  /* 选中态下的按钮样式 */
  .project-item.active .generate-btn {
    background-color: #ffffff !important;
    color: #0d6efd !important;
    border-color: #ffffff !important;
  }

  /* 项目名称点击区域样式 */
  .project-name {
    cursor: pointer;
    padding: 2px 5px;
    border-radius: 3px;
    color: #212529; /* 默认文字颜色 */
  }

  .project-name:hover {
    background-color: rgba(13, 110, 253, 0.1);
  }

  /* 表格强制按列宽布局 */
  #caseTable {
    table-layout: fixed; /* 关键：强制表格按列宽布局 */
    width: 100%; /* 设置表格宽度为100%，使其适应容器 */
  }

  /* 表格单元格样式：除操作列外，其他列都设置截断和省略号 */
  #caseTable th:not(:nth-child(7)),
  #caseTable td:not(:nth-child(7)) {
    white-space: nowrap; /* 强制不换行 */
    overflow: hidden;    /* 溢出隐藏 */
    text-overflow: ellipsis; /* 溢出显示省略号 */
    vertical-align: middle;
  }

  /* 各列宽度设置 */
  #caseTable th:nth-child(1), #caseTable td:nth-child(1) {
    width: 4em;
  }
  #caseTable th:nth-child(2), #caseTable td:nth-child(2) {
    width: 6em;
  }
  #caseTable th:nth-child(3), #caseTable td:nth-child(3) {
    width: 6em;
  }
  #caseTable th:nth-child(4), #caseTable td:nth-child(4) {
    width: 6em;
  }
  #caseTable th:nth-child(5), #caseTable td:nth-child(5) {
    width: 12em;
  }
  #caseTable th:nth-child(6), #caseTable td:nth-child(6) {
    width: 6em;
  }
  /* ===================== 新增：判定规则列允许换行 ===================== */
  #caseTable th:nth-child(7), #caseTable td:nth-child(7) {
    min-width: 16em;
    white-space: normal !important; /* 允许换行 */
    word-break: break-all; /* 长文本自动换行 */
    vertical-align: middle;
  }
</style>
{% endblock %}