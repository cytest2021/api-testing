{% extends "index.html" %} 
{% block content %}
<div class="container mt-5">
    <h3>导入接口文档</h3>
    <!-- 上传表单 -->
    <form id="uploadForm" enctype="multipart/form-data" class="mt-4">
        <div class="mb-3">
            <label for="projectName" class="form-label">项目名称</label>
            <input
                type="text"
                class="form-control"
                id="projectName"
                name="project_name"
                required
                placeholder="输入项目名称（如：电商系统接口测试）"
            />
        </div>

        <!-- 项目描述输入框 -->
        <div class="mb-3">
            <label for="projectDesc" class="form-label">项目描述</label>
            <textarea
                class="form-control"
                id="projectDesc"
                name="project_desc"
                rows="3"
                placeholder="输入项目描述（可选）"
            ></textarea>
        </div>

        <div class="mb-3">
            <label for="apiFile" class="form-label">选择接口文件</label>
            <input
                type="file"
                class="form-control"
                id="apiFile"
                name="file"
                accept=".xlsx, .xls, .json"
                required
            />
            <small class="text-muted"
                >支持的格式：
                <br>- Excel(.xlsx, .xls)：表头需包含接口名称、URL、请求方法、请求头参数、请求参数、响应结果
                <br>- Postman(.json)：支持Postman导出的Collections格式</small
            >
        </div>

        <button type="submit" class="btn btn-primary">上传并解析</button>
    </form>

    <!-- 解析结果展示 -->
    <div id="result" class="mt-4 p-3 rounded border d-none"></div>
</div>

<script>
  document.getElementById("uploadForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const resultDiv = document.getElementById("result");
    const submitButton = e.submitter;
    const fileInput = document.getElementById("apiFile");

    // 重置结果区域
    resultDiv.className = "mt-4 p-3 rounded border d-none";
    resultDiv.textContent = "";

    try {
      // 前端基本验证
      if (!fileInput.files.length) {
        showError("请选择要上传的文件");
        return;
      }

      // 获取文件信息
      const file = fileInput.files[0];
      const fileName = file.name.toLowerCase();
      let fileType = '';

      // 严格判断文件类型
      if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
        fileType = 'excel';
      } else if (fileName.endsWith('.json')) {
        fileType = 'postman';
      } else {
        showError("不支持的文件格式，请选择 .xlsx、.xls 或 .json 格式的文件");
        return;
      }

      // 禁用按钮防止重复提交
      submitButton.disabled = true;
      submitButton.textContent = "上传中...";

      // 发送请求，明确设置请求头传递文件类型
      const response = await fetch("{{ url_for('main.handle_import') }}", {
        method: "POST",
        body: formData,
        headers: {
          "X-File-Type": fileType, // 关键：传递文件类型到后端
          "Accept": "application/json"
        },
      });

      // 解析响应
      let data;
      try {
        data = await response.json();
      } catch (jsonError) {
        throw new Error("服务器返回格式错误，无法解析");
      }

      // 处理不同响应状态
      if (response.ok) {
        // HTTP状态码正常的情况
        if (data.success) {
          if (data.parse_success) {
            // 完全成功 - 显示成功信息并跳转
            resultDiv.className = "mt-4 p-3 rounded border border-success bg-success bg-opacity-10";
            resultDiv.textContent = `上传并解析${fileType === 'excel' ? 'Excel' : 'Postman'}接口成功，即将跳转到接口管理页面...`;
            resultDiv.classList.remove("d-none");

            // 延迟跳转
            setTimeout(() => {
              window.location.href = "{{ url_for('main.interface_management') }}";
            }, 1500);
          } else {
            // 解析失败 - 显示详细错误信息
            const errorMsg = data.error || `${fileType === 'excel' ? 'Excel' : 'Postman'}解析失败，请检查文件格式和内容`;
            // 处理表头或格式错误的情况
            if (fileType === 'excel' && (errorMsg.includes("缺少必要表头") || errorMsg.includes("表头"))) {
              resultDiv.textContent = `解析失败：Excel 表头异常 - ${errorMsg}`;
            } else if (fileType === 'postman' && errorMsg.includes("格式")) {
              resultDiv.textContent = `解析失败：Postman JSON 格式异常 - ${errorMsg}`;
            } else {
              resultDiv.textContent = `解析失败：${errorMsg}`;
            }
            resultDiv.className = "mt-4 p-3 rounded border border-danger bg-danger bg-opacity-10";
            resultDiv.classList.remove("d-none");
            // 恢复按钮状态
            submitButton.disabled = false;
            submitButton.textContent = "重新上传";
          }
        } else {
          // 服务器接收请求失败（参数错误等）
          resultDiv.className = "mt-4 p-3 rounded border border-warning bg-warning bg-opacity-10";
          resultDiv.textContent = `操作失败：${data.error || "请检查输入信息后重试"}`;
          resultDiv.classList.remove("d-none");
          submitButton.disabled = false;
          submitButton.textContent = "重新上传";
        }
      } else {
        // HTTP状态码异常的情况
        throw new Error(`服务器错误 (${response.status})：${data.error || "请稍后重试"}`);
      }
    } catch (error) {
      // 网络错误或其他异常
      resultDiv.className = "mt-4 p-3 rounded border border-danger bg-danger bg-opacity-10";
      resultDiv.textContent = `上传失败：${error.message}`;
      resultDiv.classList.remove("d-none");
      submitButton.disabled = false;
      submitButton.textContent = "上传并解析";
    }
  });

  // 辅助函数：显示错误信息
  function showError(message) {
    const resultDiv = document.getElementById("result");
    resultDiv.className = "mt-4 p-3 rounded border border-danger bg-danger bg-opacity-10";
    resultDiv.textContent = message;
    resultDiv.classList.remove("d-none");

    // 恢复按钮状态
    const submitButton = document.querySelector("#uploadForm button[type='submit']");
    submitButton.disabled = false;
    submitButton.textContent = "上传并解析";
  }
</script>
{% endblock %}