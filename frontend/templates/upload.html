{% extends "index.html" %} 
{% block content %}
<div class="container mt-5">
    <h3>导入Excel接口文档</h3>
    <!-- 上传表单 -->
    <form id="uploadForm" enctype="multipart/form-data" class="mt-4">
        <div class="mb-3">
            <label for="projectName" class="form-label">项目名称</label>
            <input
                type="text"
                class="form-control"
                id="projectName"
                name="project_name"
                required
                placeholder="输入项目名称（如：电商系统接口测试）"
            />
        </div>

        <div class="mb-3">
            <label for="excelFile" class="form-label">选择Excel文件</label>
            <input
                type="file"
                class="form-control"
                id="excelFile"
                name="file"
                accept=".xlsx, .xls"
                required
            />
            <small class="text-muted"
                >支持.xlsx和.xls格式，表头需包含：接口名称、URL、方法、参数名、参数类型、是否必填、数据类型</small
            >
        </div>

        <button type="submit" class="btn btn-primary">上传并解析</button>
    </form>

    <!-- 解析结果展示 -->
    <div id="result" class="mt-4 p-3 rounded border d-none"></div>
</div>

<script>
  document
    .getElementById("uploadForm")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const resultDiv = document.getElementById("result");
      const submitButton = e.submitter;

      try {
        // 禁用按钮防止重复提交
        submitButton.disabled = true;
        submitButton.textContent = "上传中...";

        // 请求头配置
        const headers = {
          "X-Import-Source": "Excel-Upload",
          Accept: "application/json",
        };

        // 发送请求，注意路由要对应蓝图命名空间，这里假设 main 蓝图已正确注册
        const response = await fetch(
          "{{ url_for('main.handle_import') }}", 
          {
            method: "POST",
            body: formData,
            headers: headers,
          }
        );

        // 处理响应
        if (!response.ok) {
          throw new Error(`HTTP错误，状态码: ${response.status}`);
        }

        const data = await response.json();

        // 显示成功提示并处理跳转
        if (data.success) {
          resultDiv.className =
            "mt-4 p-3 rounded border border-success bg-success bg-opacity-10";
          resultDiv.textContent =
            "上传接口成功，即将跳转到接口管理页面...";
          resultDiv.classList.remove("d-none");

          // 延迟1.5秒后跳转到 interface_management 路由对应的页面，用 url_for 更稳妥
          setTimeout(() => {
            window.location.href = "{{ url_for('main.interface_management') }}";
          }, 1500);
        } else if (data.result?.includes("解析完成")) {
          resultDiv.className =
            "mt-4 p-3 rounded border border-success bg-success bg-opacity-10";
          resultDiv.textContent = "上传接口成功";
          resultDiv.classList.remove("d-none");
        } else {
          resultDiv.className =
            "mt-4 p-3 rounded border border-warning bg-warning bg-opacity-10";
          resultDiv.textContent =
            data.result || "上传完成，但未解析到接口数据";
          resultDiv.classList.remove("d-none");
        }
      } catch (error) {
        resultDiv.className =
          "mt-4 p-3 rounded border border-danger bg-danger bg-opacity-10";
        resultDiv.textContent = "上传失败：" + error.message;
        resultDiv.classList.remove("d-none");
      } finally {
        // 恢复按钮状态（如果没有跳转的话）
        if (!resultDiv.textContent.includes("即将跳转")) {
          submitButton.disabled = false;
          submitButton.textContent = "上传并解析";
        }
      }
    });
</script>
{% endblock %}