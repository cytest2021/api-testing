{% extends "index.html" %}
{% block head %}
<!-- 仅保留额外样式，不重复定义head标签 -->
<style>
  .permission-checkbox {
    margin-right: 5px;
  }

  .user-table th,
  .user-table td {
    vertical-align: middle;
  }
</style>
{% endblock %}

{% block content %}
<!-- 所有页面内容放入content块中 -->
<div class="container mt-5">
  <h2 class="mb-4">用户管理</h2>

  <!-- 用户列表表格 -->
  <table class="table table-striped table-bordered user-table">
    <thead>
      <tr>
        <th>用户ID</th>
        <th>用户名</th>
        <th>角色</th>
        <th>权限</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <!-- 假用户数据 -->
      <tr>
        <td>1</td>
        <td>superAdmin</td>
        <td>超级管理员</td>
        <td>所有权限</td>
        <td>
          <button class="btn btn-primary btn-sm" disabled>编辑权限</button>
          <button class="btn btn-danger btn-sm" disabled>删除用户</button>
        </td>
      </tr>
      <tr>
        <td>2</td>
        <td>admin</td>
        <td>管理员</td>
        <td>
          <button class="btn btn-primary btn-sm" data-user-id="2" onclick="openPermissionModal(this)">编辑权限</button>
        </td>
        <td>
          <button class="btn btn-danger btn-sm" data-user-id="2" onclick="deleteUser(this)">删除用户</button>
        </td>
      </tr>
      <tr>
        <td>3</td>
        <td>testUser1</td>
        <td>普通测试员</td>
        <td>
          <button class="btn btn-primary btn-sm" data-user-id="3" onclick="openPermissionModal(this)">编辑权限</button>
        </td>
        <td>
          <button class="btn btn-danger btn-sm" data-user-id="3" onclick="deleteUser(this)">删除用户</button>
        </td>
      </tr>
      <tr>
        <td>4</td>
        <td>testUser2</td>
        <td>普通测试员</td>
        <td>
          <button class="btn btn-primary btn-sm" data-user-id="4" onclick="openPermissionModal(this)">编辑权限</button>
        </td>
        <td>
          <button class="btn btn-danger btn-sm" data-user-id="4" onclick="deleteUser(this)">删除用户</button>
        </td>
      </tr>
      <tr>
        <td>5</td>
        <td>testUser3</td>
        <td>普通测试员</td>
        <td>
          <button class="btn btn-primary btn-sm" data-user-id="5" onclick="openPermissionModal(this)">编辑权限</button>
        </td>
        <td>
          <button class="btn btn-danger btn-sm" data-user-id="5" onclick="deleteUser(this)">删除用户</button>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- 添加用户按钮 -->
  <button class="btn btn-success" onclick="openAddUserModal()">添加用户</button>
</div>

<!-- 添加用户模态框 -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">添加用户</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addUserForm">
          <div class="mb-3">
            <label for="addUsername" class="form-label">用户名</label>
            <input type="text" class="form-control" id="addUsername" required>
          </div>
          <div class="mb-3">
            <label for="addPassword" class="form-label">密码</label>
            <input type="password" class="form-control" id="addPassword" required>
          </div>
          <div class="mb-3">
            <label for="addRole" class="form-label">角色</label>
            <select class="form-select" id="addRole" required>
              <option value="admin">管理员</option>
              <option value="tester" selected>普通测试员</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" onclick="submitAddUserForm()">确定</button>
      </div>
    </div>
  </div>
</div>

<!-- 权限分配模态框 -->
<div class="modal fade" id="permissionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">权限分配</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="permissionForm">
          <input type="hidden" id="userId">
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input permission-checkbox" type="checkbox" value="all" id="allPermissions">
              <label class="form-check-label" for="allPermissions">
                所有权限
              </label>
            </div>
          </div>
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input permission-checkbox" type="checkbox" value="interfaceImport" id="interfaceImport">
              <label class="form-check-label" for="interfaceImport">
                接口导入
              </label>
            </div>
          </div>
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input permission-checkbox" type="checkbox" value="interfaceView" id="interfaceView">
              <label class="form-check-label" for="interfaceView">
                接口管理-查看
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input permission-checkbox" type="checkbox" value="interfaceEdit" id="interfaceEdit">
              <label class="form-check-label" for="interfaceEdit">
                接口管理-编辑
              </label>
            </div>
          </div>
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input permission-checkbox" type="checkbox" value="caseView" id="caseView">
              <label class="form-check-label" for="caseView">
                用例管理-查看
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input permission-checkbox" type="checkbox" value="caseEdit" id="caseEdit">
              <label class="form-check-label" for="caseEdit">
                用例管理-编辑
              </label>
            </div>
          </div>
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input permission-checkbox" type="checkbox" value="planView" id="planView">
              <label class="form-check-label" for="planView">
                测试计划管理-查看
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input permission-checkbox" type="checkbox" value="planEdit" id="planEdit">
              <label class="form-check-label" for="planEdit">
                测试计划管理-编辑
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input permission-checkbox" type="checkbox" value="planExecute" id="planExecute">
              <label class="form-check-label" for="planExecute">
                测试计划管理-执行
              </label>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" onclick="submitPermissionForm()">保存</button>
      </div>
    </div>
  </div>
</div>

<!-- 引入 Bootstrap JS（建议在父模板index.html中统一引入，避免重复） -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // 当前编辑的用户ID
  let currentEditUserId = null;

  // 打开添加用户模态框
  function openAddUserModal() {
    const addUserModal = new bootstrap.Modal(document.getElementById('addUserModal'));
    addUserModal.show();
  }

  // 提交添加用户表单
  function submitAddUserForm() {
    const username = document.getElementById('addUsername').value;
    const password = document.getElementById('addPassword').value;
    const role = document.getElementById('addRole').value;

    if (!username || !password) {
      alert('用户名和密码不能为空');
      return;
    }

    // 这里可以添加发送请求到后端的逻辑，模拟添加成功
    alert(`用户 ${username} 添加成功，角色：${role === 'admin' ? '管理员' : '普通测试员'}`);

    const addUserModal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
    addUserModal.hide();

    // 重置表单
    document.getElementById('addUserForm').reset();
  }

  // 打开权限分配模态框
  function openPermissionModal(button) {
    currentEditUserId = button.getAttribute('data-user-id');
    document.getElementById('userId').value = currentEditUserId;

    // 这里可以根据用户ID从后端获取已有权限并选中对应的复选框，模拟数据
    const permissions = {
      '2': ['all'],
      '3': ['interfaceImport', 'caseView', 'planView'],
      '4': ['interfaceView', 'caseEdit', 'planExecute'],
      '5': ['interfaceEdit', 'planEdit']
    };

    const userPermissions = permissions[currentEditUserId] || [];

    // 先取消所有复选框选中状态
    document.querySelectorAll('.permission-checkbox').forEach(checkbox => {
      checkbox.checked = false;
    });

    // 选中对应权限
    userPermissions.forEach(perm => {
      document.getElementById(perm).checked = true;
    });

    // 处理全选逻辑
    updateAllPermissionsCheckbox();

    const permissionModal = new bootstrap.Modal(document.getElementById('permissionModal'));
    permissionModal.show();
  }

  // 更新全选复选框状态
  function updateAllPermissionsCheckbox() {
    const allPermissionsCheckbox = document.getElementById('allPermissions');
    const otherCheckboxes = document.querySelectorAll('.permission-checkbox:not(#allPermissions)');

    let allChecked = true;
    otherCheckboxes.forEach(checkbox => {
      if (!checkbox.checked) {
        allChecked = false;
      }
    });

    allPermissionsCheckbox.checked = allChecked;
  }

  // 全选复选框点击事件
  document.getElementById('allPermissions').addEventListener('change', function () {
    const isChecked = this.checked;
    const otherCheckboxes = document.querySelectorAll('.permission-checkbox:not(#allPermissions)');

    otherCheckboxes.forEach(checkbox => {
      checkbox.checked = isChecked;
    });
  });

  // 其他复选框点击事件，更新全选状态
  document.querySelectorAll('.permission-checkbox:not(#allPermissions)').forEach(checkbox => {
    checkbox.addEventListener('change', updateAllPermissionsCheckbox);
  });

  // 提交权限分配表单
  function submitPermissionForm() {
    const userId = document.getElementById('userId').value;
    const selectedPermissions = [];

    document.querySelectorAll('.permission-checkbox:checked').forEach(checkbox => {
      selectedPermissions.push(checkbox.value);
    });

    // 这里可以添加发送请求到后端的逻辑，模拟保存成功
    alert(`用户ID为 ${userId} 的权限已保存，选中的权限：${selectedPermissions.join(', ')}`);

    const permissionModal = bootstrap.Modal.getInstance(document.getElementById('permissionModal'));
    permissionModal.hide();
  }

  // 删除用户
  function deleteUser(button) {
    const userId = button.getAttribute('data-user-id');
    const username = button.closest('tr').querySelector('td:nth-child(2)').textContent;

    if (confirm(`确定要删除用户 ${username} 吗？`)) {
      // 这里可以添加发送请求到后端的逻辑，模拟删除成功
      alert(`用户 ${username} 删除成功`);

      // 从表格中移除该行
      button.closest('tr').remove();
    }
  }
</script>
{% endblock %}